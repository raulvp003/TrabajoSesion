<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIGN UP</title>
  <link rel="icon" type="image/png" href="../logo.png" />
  <link rel="stylesheet" href="CSSlogin.css" />
  <link rel="stylesheet" href="../darkMode.css"><!-- Archivo CSS alternativo. Modo oscuro. -->
    <script type="text/javascript" src="../darkMode.js" defer></script><!-- Archivo js alternativo. Modo oscuro. -->
</head>
<body>
   <img id="darkModeToggle" src="../moon.png" alt="dark mode">
  <div class="container">
    <!-- Logo that links back to homepagee -->
    <a href="../index.html"><img id="logo" src="../logo.png" alt="Logo"></a>

    <div id="form">
        <h1 id="titulo">SIGN UP</h1>
      <!-- Sign-up form -->
      <form id="signUpForm">
        <div class="fila">
          <div class="campo">
            <label for="FirstName">First Name</label>
            <input type="text" id="FirstName" name="FirstName" placeholder="First Name">
          </div>
          <div class="campo">
            <label for="MiddleInitial">Middle Initial</label>
            <input type="text" id="MiddleInitial" name="MiddleInitial" placeholder="Middle Initial">
          </div>
        </div>

        <div class="campo">
          <label for="LastName">Last Name</label>
          <input type="text" id="LastName" name="LastName" placeholder="Last Name">
        </div>

        <div class="campo">
          <label for="Street">Street</label>
          <input type="text" id="Street" name="Street" placeholder="Street">
        </div>

        <div class="campo">
          <label for="City">City</label>
          <input type="text" id="City" name="City" placeholder="City">
        </div>

        <div class="fila">
          <div class="campo">
            <label for="State">State</label>
            <input type="text" id="State" name="State" placeholder="State">
          </div>
          <div class="campo">
            <label for="Zip">ZIP Code</label>
            <input type="text" id="Zip" name="Zip" placeholder="ZIP Code">
          </div>
        </div>

        <div class="campo">
          <label for="Phone">Phone</label>
          <input type="text" id="Phone" name="Phone" placeholder="Phone">
        </div>

        <div class="campo">
          <label for="Email">Email</label>
          <input type="email" id="Email" name="Email" placeholder="Email">
        </div>

        <div class="fila">
          <div class="campo">
            <label for="Password">Password</label>
            <input type="password" id="Password" name="Password" placeholder="Password">
            <!-- Button to show/hide password -->
            <button type="button" class="toggle-password" data-target="Password">
              <img src="https://cdn-icons-png.flaticon.com/512/159/159604.png" alt="Show">
            </button>
          </div>
          <div class="campo">
            <label for="ConfirmPassword">Confirm Password</label>
            <input type="password" id="ConfirmPassword" name="ConfirmPassword" placeholder="Confirm Password">
            <!-- Button to show/hide password -->
            <button type="button" class="toggle-password" data-target="ConfirmPassword">
              <img src="https://cdn-icons-png.flaticon.com/512/159/159604.png" alt="Show">
            </button>
          </div>
        </div>

        <!-- Message box for errors/success -->
        <div id="responseMsgSignUp" style="display:none;"></div>

        <!-- Submit button -->
        <button type="submit">REGISTER</button>

        <!-- Link to login page -->
        <div id="registro">
          Already have an account?
          <a href="../signin/signin.html">Log in</a>
        </div>
      </form>
    </div>
  </div>

<script>
  // ===== Field Validation on Blur =====
  // Function to validate input fields when the user leaves them
  function addBlurValidation(id, regex, errorMessage) {
    const field = document.getElementById(id);
    field.addEventListener("blur", function() {
      const msgBox = document.getElementById("responseMsgSignUp");
      const value = field.value.trim();

      // Hide message if the field is empty
      if (value === "") {
        msgBox.style.display = "none";
        return;
      }

      // If the value does not match regex, show error
      if (!regex.test(value)) {
        msgBox.className = "error";
        msgBox.textContent = "Error: " + errorMessage;
        msgBox.style.display = "block";
      } else {
        msgBox.style.display = "none";
      }
    });
  }

  // Adding validation for each field
  addBlurValidation("FirstName", /^[A-Za-zÁÉÍÓÚáéíóúñÑ\s]{2,50}$/, "First name must contain only letters and spaces (2–50 characters).");
  addBlurValidation("MiddleInitial", /^[A-Za-zÁÉÍÓÚáéíóúñÑ]{1}$/, "Middle initial can only be one letter");
  addBlurValidation("LastName", /^[A-Za-zÁÉÍÓÚáéíóúñÑ\s]{2,50}$/, "Last name must contain only letters and spaces (2–50 characters).");
  addBlurValidation("Street", /^[A-Za-zÁÉÍÓÚáéíóúñÑ0-9\s]{2,90}$/, "Street can contain letters, numbers, and spaces (2–90 characters).");
  addBlurValidation("City", /^[A-Za-zÁÉÍÓÚáéíóúñÑ\s]{2,50}$/, "City must contain only letters and spaces (2–50 characters).");
  addBlurValidation("State", /^[A-Za-zÁÉÍÓÚáéíóúñÑ\s]{2,50}$/, "State must contain only letters and spaces (2–50 characters).");
  addBlurValidation("Zip", /^[0-9]{4,10}$/, "ZIP Code must contain between 4 and 10 digits.");
  addBlurValidation("Phone", /^[0-9]{9,15}$/, "Phone number must contain between 9 and 15 digits.");
  addBlurValidation("Email", /^(?=.{1,255}$)[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,255}$/, "Please enter a valid email (example@domain.com) with maximum 255 characters.");
  addBlurValidation("Password", /^(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,255}$/, "Password must have at least 8 characters, one uppercase letter, one number, and one symbol.");

  // ===== Show/Hide Password =====
  // Toggles password visibility when icon is clicked
  document.querySelectorAll(".toggle-password").forEach(btn => {
    btn.addEventListener("click", () => {
      const targetId = btn.getAttribute("data-target");
      const input = document.getElementById(targetId);
      const img = btn.querySelector("img");

      // Switch between password and text type
      if (input.type === "password") {
        input.type = "text";
        img.src = "https://cdn-icons-png.flaticon.com/512/565/565655.png"; // Eye open
      } else {
        input.type = "password";
        img.src = "https://cdn-icons-png.flaticon.com/512/159/159604.png"; // Eye closed
      }
    });
  });

  // ===== Customer Constructor =====
  // Object model for a customer
  function Customer(id, firstName, middleInitial, lastName, street, city, state, zip, phone, email, password) {
    this.id = id;
    this.firstName = firstName;
    this.middleInitial = middleInitial;
    this.lastName = lastName;
    this.street = street;
    this.city = city;
    this.state = state;
    this.zip = zip;
    this.phone = phone;
    this.email = email;
    this.password = password;
  }

  // Convert customer data into XML format
  Customer.prototype.toXML = function() {
    return `
      <customer>
        <id>${this.id}</id>
        <firstName>${this.firstName}</firstName>
        <middleInitial>${this.middleInitial}</middleInitial>
        <lastName>${this.lastName}</lastName>
        <street>${this.street}</street>
        <city>${this.city}</city>
        <state>${this.state}</state>
        <zip>${this.zip}</zip>
        <phone>${this.phone}</phone>
        <email>${this.email}</email>
        <password>${this.password}</password>
      </customer>
    `.trim();
  };

  // ===== Save email in session =====
  // Stores the user's email in sessionStorage
  function guardarDatosSesion(email) {
    sessionStorage.setItem("email", email);
    console.log("Email stored in session: " + email);
  }

  // ===== Handle form submission =====
  function handleSignUpOnClick(e) {
    e.preventDefault(); // Prevent default form submit
    const msgBox = document.getElementById("responseMsgSignUp");
    const titulo = document.getElementById("titulo");

    // Get values from all inputs
    const firstName = document.getElementById("FirstName").value.trim();
    const middleInitial = document.getElementById("MiddleInitial").value.trim();
    const lastName = document.getElementById("LastName").value.trim();
    const street = document.getElementById("Street").value.trim();
    const city = document.getElementById("City").value.trim();
    const state = document.getElementById("State").value.trim();
    const zip = document.getElementById("Zip").value.trim();
    const phone = document.getElementById("Phone").value.trim();
    const email = document.getElementById("Email").value.trim();
    const password = document.getElementById("Password").value.trim();
    const confirmPassword = document.getElementById("ConfirmPassword").value.trim();

    try {
      // Check that all fields are filled
      if (!firstName || !lastName || !street || !city || !state || !zip || !phone || !email || !password || !confirmPassword) {
        throw new Error("All fields must be completed.");
      }

      // Regex validation patterns
      const nameRegex = /^[A-Za-zÁÉÍÓÚáéíóúñÑ\s]{2,50}$/;
      const miRegex = /^[A-Za-zÁÉÍÓÚáéíóúñÑ]{1}$/;
      const streetRegex = /^[A-Za-zÁÉÍÓÚáéíóúñÑ0-9\s]{2,90}$/;
      const zipRegex = /^[0-9]{4,10}$/;
      const phoneRegex = /^[0-9]{9,15}$/;
      const emailRegex = /^(?=.{1,255}$)[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,255}$/;
      const passRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,255}$/;

      // Validation for each field
      if (!nameRegex.test(firstName)) throw new Error("First name can only contain letters and spaces (2–50 characters).");
      if (!nameRegex.test(lastName)) throw new Error("Last name can only contain letters and spaces (2–50 characters).");
      if (!miRegex.test(middleInitial)) throw new Error("The middle initial can only be one letter.");
      if (!streetRegex.test(street)) throw new Error("Street can only contain letters, numbers, and spaces (2–90 characters).");
      if (!nameRegex.test(city)) throw new Error("City can only contain letters and spaces (2–50 characters).");
      if (!nameRegex.test(state)) throw new Error("State can only contain letters and spaces (2–50 characters).");
      if (!zipRegex.test(zip)) throw new Error("ZIP code must contain between 4 and 10 digits.");
      if (!phoneRegex.test(phone)) throw new Error("Phone number must contain between 9 and 15 digits.");
      if (!emailRegex.test(email)) throw new Error("Please enter a valid email address(example@domain.com) with a maximum of 100 characters.");
      if (!passRegex.test(password))throw new Error("Password must be between 8 and 255 characters, include at least one uppercase letter, one number, and  symbol .");
      if (password !== confirmPassword) throw new Error("Passwords do not match.");

      // Create new customer object
      const id = Date.now();
      const customer = new Customer(id, firstName, middleInitial, lastName, street, city, state, zip, phone, email, password);
      const xml = customer.toXML();
      sessionStorage.setItem("customer.id", customer.id);

      // ===== Send data to server =====
      fetch("/CRUDBankServerSide/webresources/customer", {
        method: 'POST',
        headers: { 'Content-Type': 'application/xml' },
        body: xml
      })
      .then(response => {
        // Handle different server responses
        if (response.status === 403) throw new Error("That email is already in use.");
        if (response.status === 500) throw new Error("It was not possible to connect to the server.");
        if (!response.ok) throw new Error("An unexpected error occurred.");
        return response.text();
      })
      .then(text => {
        // If registration successful
        console.log("Server response:", text);
        guardarDatosSesion(email);

        msgBox.textContent = '✅ User successfully registered ✅';
        msgBox.style.display = 'block';
        msgBox.style.backgroundColor = 'green';
        titulo.style.backgroundColor = 'green';

        // Redirect to login page after 1 second
        setTimeout(() => {
          window.location.href = "../signin/signin.html"; 
        }, 1000);
      })
      .catch(error => {
        // Handle server or fetch errors
        console.error(error);
        msgBox.textContent = '✖️ ' + error.message;
        msgBox.style.display = 'block';
        msgBox.style.backgroundColor = 'red';
        titulo.style.backgroundColor = 'red';
      });

    } catch (error) {
      // Handle any local validation errors
      msgBox.textContent = "✖️ " + error.message;
      msgBox.style.display = "block";
      msgBox.style.backgroundColor = 'red';
      titulo.style.backgroundColor = 'red';
    }
  }

  // Event listener for form submission
  document.getElementById("signUpForm").addEventListener("submit", handleSignUpOnClick);
</script>
</body>
</html>
